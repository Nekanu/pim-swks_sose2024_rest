\chapter{Tests}

\section{Load Tests}

Während funktionale Tests die Korrektheit der Implementierung prüfen,
evaluieren Load Tests die Performance des Systems unter hoher Last,
beispielsweise bei vielen nebenläufigen Zugriffen.

Es gibt zahlreiche Gründe eine Anwendung Load Tests zu unterziehen.
Diese sind unter anderem:

\begin{itemize}
    \item Performance des Systems messen
    \item Bottlenecks identifizieren
    \item Skalierbarkeit des Systems bewerten
    \item Race Conditions entdecken
\end{itemize}

Zur Umsetzung dieser Tests wird JMeter \& 5.4.1 \& \url{https://jmeter.apache.org/} eingesetzt.

\subsection{Starten von JMeter}

JMeter kann im GUI- oder CLI-Modus gestartet werden.
Der GUI-Modus wird zum Erstellen und Debuggen von Tests eingesetzt,
welche anschließend im CLI-Modus ausgeführt werden können.

JMeter startet standardmäßig im GUI-Modus.
Um Tests im CLI-Modus auszuführen, kann folgender Befehle eingesetzt werden.

\begin{lstlisting}
    jmeter -n -t testplan/TestPlan.jmx -l "results/result.jtl" -j "logs/logs.log"
\end{lstlisting}

Die eingesetzten Optionen haben folgende Bedeutung:

\begin{itemize}
    \item \texttt{-n} - CLI-Modus
    \item \texttt{-t} - Pfad zum Testplan
    \item \texttt{-l} - Pfad zur Testlogdatei (Testergebnisse)
    \item \texttt{-j} - Pfad zur Jmeterlogdatei (Informationen über Testausführung und aufgetretene Fehler)
\end{itemize}

\subsection{Erstellung von Testplänen}

Tests werden in Form eines Testplans geschrieben.
Ein Testplan ist ein Baum, der Elemente aus verschiedenen Kategorien enthalten kann (siehe \url{https://jmeter.apache.org/usermanual/test_plan.html}).

\begin{itemize}
    \item Thread Group\hfill
          \\Kontrolliert wie oft Sampler ausgeführt werden, insbesondere wie viele Anfragen nebenläufig stattfinden.
    \item Logic Controllers\hfill
          \\Beeinflusst die Ausführungsreihenfolge der Sampler.
    \item Samplers\hfill
          \\Die auszuführenden Tests, z.B. HTTP-Anfragen.
    \item Listener\hfill
          \\Speichert die Ergebnisse eines Samplers und kann diese im GUI-Modus grafisch aufbereiten.
    \item Configuration Elements\hfill
          \\Stellen Daten für Tests zur Verfügung, unter anderem durch Definition von Konstanten, Erzeugung zufälliger Werte oder Einlesen externen Dateien.
\end{itemize}

Grundsätzlich beinhaltet ein Testplan \texttt{Thread Groups}.
Jeder Thread steht für einen User.
\texttt{Thread Groups} enthalten \texttt{Sampler}, welche von jeden Thread von oben nach unten ausgeführt werden.
\texttt{Samplers} enthalten (einen) Listener, welcher die Ergebnisse aufzeichnet und im GUI-Modus visualisieren kann.
\texttt{Configuration Elements} werden nach Bedarf als Kinder von \texttt{Thread Groups} oder \texttt{Samplers} definiert.


\subsection{Verwendung von Variablen}

JMeter ermöglicht die Definition von Variablen, um Tests besser wart- und anpassbar zu machen.
Hierzu kann etwas das Configuration Element \texttt{User Defined Variables} eingesetzt werden.
In diesem Element definierte Konstanten können grundsätzlich mit der Syntax \texttt{\$\{Variablenname\}} referenziert werden.

Leider wird diese Art Variablen zu referenzieren nicht überall unterstützt.
Beispielsweise funktioniert dies im Körper einer HTTP Request und zur Angabe der Widerholungen eines Tests,
aber nicht bei der Angabe von Dateipfaden.

In solchen Fällen kann der Wert einer Variable oftmals mit Groovy\footnote{\url{https://www.groovy-lang.org/}} ausgelesen werden.
Dies ist mit folgender Syntax möglich: \texttt{\$\{\_\_groovy(vars.get("Variablenname"))\}}.
Leider funktioniert auch dieser Ansatz nicht in allen Fällen.

Der Einsatz von Groovy ermöglicht die Berechnung von Konstanten in Abhängigkeit von anderen Konstanten.
Die abhängige Konstante muss in einem eigenen \texttt{User Defined Variables}-Element definiert werden.
Dieses muss sich im Baum unter dem ursprünglichen Konfigurationselement befinden.
Wird die Konstante im gleichen Element oder einem im Baum höherstehenden Element definiert,
scheitert die Definition der abhängigen Variable und sie wird als leerer String behandelt.

Um Fehler beim Einsatz von Variablen zu untersuchen,
kann der Sampler \texttt{Debug Sampler} eingesetzt werden.
Dieser wertet bei Ausführung alle verfügbaren Variablen aus, sodass deren Werte überprüft werden können.
Die Werte sind im GUI-Modus als \texttt{Response Data} des zum Sampler hinzugefügten Listener einsehbar.

\subsection{Relative Pfade}

JMeter bietet keine vollständige Unterstützung für relative Pfade.

Die Angabe relativer Pfade ist im GUI-Modus nicht möglich.
Ersetzt man im durch den GUI-Modus erzeugten Testplan, einer XML-Datei, absolute durch relative Pfade,
so werden diese im CLI-Modus korrekt aufgelöst.
Öffnet man den manipulierten Testplan erneut im GUI-Modus,
kann JMeter die relative Pfade jedoch nicht auflösen.

Um trotzdem absolute Pfade zu vermeiden,
kann ein absoluter Basispfad als Konstante definiert werden.
Pfade werden dann als Konkatenation dieser Variable und des gewünschten relativen Pfades definiert.
Somit muss nur der Basispfad angepasst werden, um die Ausführung auf einer anderen Maschine zu ermöglichen.

\begin{lstlisting}[caption=Workaround zur Angabe relativer Pfade]
    ${__groovy(vars.get("PathBase"))}/listeners
\end{lstlisting}
